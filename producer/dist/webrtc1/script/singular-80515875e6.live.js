"use strict";var outputName,credentials=void 0,pvwPlayer=void 0,singularPage=null,pvwStates=[],pgmStates=[],changeComp={},singularAcount=null;function getSingularCount(){oUtils.ajaxReq("/producerpro/querySingularLiveAccount",null,function(t){if("0x0"!==t.errorCode)return oUtils.alertTips(t.errorInfo),!1;$(".sd-pretreat-container .pretreat-content.show-singular").removeClass("hide"),"{}"==JSON.stringify(t.result)?($(".show-singular .auth-singular").removeClass("hide"),$(".show-singular .singular-list").addClass("hide")):(singularAcount=t.result,$(".show-singular .auth-singular").addClass("hide"),$(".show-singular .singular-list").removeClass("hide"),getSingularInstances())})}function setSingularList(t,o){if(0==$(".operation-show .operation-view-singular li").length){var a={token:t};oUtils.ajaxReq("/producerpro/getCompositionsMsg",a,function(t){if(console.log(t),"0x0"==t.errorCode){var o=t.result,a="",i={comp:"Lower",arr:[]},n={comp:"Fullscreen",arr:[]},e={comp:"Baseline",arr:[]},s={comp:"Panel",arr:[]},r={comp:"Upper Left",arr:[]},l={comp:"Upper Right",arr:[]};o.forEach(function(t){t.mainComposition||(-1<t.compositionName.indexOf("Lower")?i.arr.push(t):-1<t.compositionName.indexOf("Fullscreen")?n.arr.push(t):-1<t.compositionName.indexOf("Baseline")?e.arr.push(t):-1<t.compositionName.indexOf("Panel")?s.arr.push(t):-1<t.compositionName.indexOf("Upper Left")?r.arr.push(t):-1<t.compositionName.indexOf("Upper Right")&&l.arr.push(t))}),console.log(i,n,e,s,r,l);a="";a=getSingularComp(i),a+=getSingularComp(n),a+=getSingularComp(e),a+=getSingularComp(s),a+=getSingularComp(r),a+=getSingularComp(l),$(".operation-show .operation-view-singular").html(a),pgmStates=JSON.parse(JSON.stringify(pvwStates))}})}}function getSingularComp(t){if(0==t.arr.length)return"";for(var o='<li class="single-view">                <div class="sidebar left">'+t.comp+'</div>                <div class="border left"></div>                <div class="contents">                    <ul class="sub_content clearFix" style="height:72px;">',a=0;a<t.arr.length;a++){var i=encodeURIComponent(JSON.stringify(t.arr[a]));o+='<li class="'+("In"==t.arr[a].animation.state?"pvwActive":"")+'" data-param="'+i+'" data-id="'+t.arr[a].compositionId+'" data-compname="'+t.arr[a].compositionName+'"><div>'+t.arr[a].compositionName+'</div><i class="icon-edit iconfont edit"></i></li>',"In"==t.arr[a].animation.state&&(pvwStates.push({compositionName:t.arr[a].compositionName,animation:{action:"play",to:"In"}}),JumpIn(t.arr[a].compositionId)),pvwPlayer.getMainComposition().getCompositionById(t.arr[a].compositionId).setPayload(t.arr[a].controlNode.payload)}return o+="</ul>                </div>            </li>"}function getSingularInstances(){oUtils.ajaxReq("/producerpro/getSingularMyshows",null,function(t){if("0x0"==t.errorCode){for(var o="",a=t.result,i=[],n=[],e=$(".show-singular .singular-list .isMyshow"),s=[],r=0;r<e.length;r++)s.push(parseInt(e.eq(r).attr("data-id")));for(r=0;r<a.length;r++)-1<s.indexOf(a[r].refId)?n.push(a[r].refId):i.push(a[r]);for(r=0;r<s.length;r++)n.indexOf(s[r])<0&&$(".show-singular .singular-list [data-id='"+s[r]+"']").remove();for(r=0;r<i.length;r++)getSingularThumbnail(i[r].refId),o+='<li class="singular-logo isMyshow" data-id="'+i[r].refId+'" title="'+i[r].name+'">                        <img src="./images/singular.png" >                    </li>';$(".show-singular .singular-list").append(o),$(".show-singular .singular-list").removeClass("hide"),$(".show-singular .auth-singular").addClass("hide")}})}function JumpIn(t){pvwPlayer.getMainComposition().getCompositionById(t).jumpTo("In")}function JumpOut(t){pvwPlayer.getMainComposition().getCompositionById(t).jumpTo("Out")}function PlayIn(t){pvwPlayer.getMainComposition().getCompositionById(t).playTo("In")}function PlayOut(t){pvwPlayer.getMainComposition().getCompositionById(t).playTo("Out")}function getSingularThumbnail(a){singularRestGET("https://app.singular.live/apiv1/appinstances/"+a,function(t){console.log(t);var o=t.outputs[0].composition.thumbnail;o&&$(".show-singular .singular-list [data-id='"+a+"'] img").attr("src",o),$(".show-singular .singular-list [data-id='"+a+"']").attr("data-token",t.access_token),$(".show-singular .singular-list [data-id='"+a+"']").attr("data-outputurl",encodeURIComponent(t.onair_url))})}function initPvwSingular(t,o){pvwPlayer=SingularPlayer("pvwSingularPlayer"),singularRestGET("https://app.singular.live/apiv1/appinstances/"+t+"/composition",function(t){console.log("appinstances",t),pvwPlayer.loadComposition(t.url,function(){o.siblings().removeClass("active"),o.addClass("active"),$(".operation-show .operation-view-singular").html(""),console.log("INFO - [initPlayerSKD()]: Composition loaded"),setSingularList(o.attr("data-token"),o.attr("data-id"))})})}function singularRestGET(t,o){credentials=btoa(singularAcount.singular_username+":"+singularAcount.singular_password),fetch(t,{method:"GET",contentType:"application/json",mode:"cors",headers:{Authorization:"Basic "+credentials}}).then(function(t){return t.ok?(console.log(t),t.json()):(console.log(t),Promise.reject("Fetch did not succeed"))}).then(function(t){o&&o(t),console.log(t)}).catch(function(t){console.log("ERROR: "+t)})}function singularRestPOST(t,o,a){var i;i={method:"PUT",contentType:"application/json",mode:"cors",headers:{Authorization:"Basic "+btoa(singularAcount.singular_username+":"+singularAcount.singular_password),"content-type":"application/json"},body:JSON.stringify(o)},fetch(t,i).then(function(t){return t.ok?(console.log(t),t.json()):(console.log(t),Promise.reject("Fetch did not succeed"))}).then(function(t){null!=t&&(a&&a(t),console.log(t))}).catch(function(t){console.log("ERROR: "+t)})}function cutToPgm(){var t=[],o=[],a=0,i=[],n=[];for(pvwStates.forEach(function(t){i.push(t.compositionName)}),pgmStates.forEach(function(t){n.push(t.compositionName)}),a=0;a<pvwStates.length;a++)n.indexOf(pvwStates[a].compositionName)<0&&t.push(pvwStates[a]);for(a=0;a<pgmStates.length;a++)i.indexOf(pgmStates[a].compositionName)<0&&(pgmStates[a].animation.to="Out",o.push(pgmStates[a]));var e=[],s=Object.keys(changeComp);for(a=0;a<s.length;a++)e.push(changeComp[s[a]]);var r=t.concat(o,e);changeComp={},pgmStates=JSON.parse(JSON.stringify(pvwStates)),PutSubcompositions(r)}function PutSubcompositions(t){singularRestPOST("https://app.singular.live/apiv1/control/"+$(".show-singular .singular-list .isMyshow.active").attr("data-token"),t,function(t){console.log(t)})}$(".sd-pretreat-box .show-singular .auth-singular .auth button").on("click",function(){var t=location.protocol+"//"+location.host+"/producerpro/singularLogin.html",o=(window.outerWidth-800)/2+"px";singularPage=window.open(t,"Singular Live login","width=860px,height=520px,menubar=no,top=200px,left="+o)}),$(".sd-pretreat-box .show-singular ").on("click",".singular-logo",function(){if($(this).hasClass("active"))return!1;var t=$(this);initPvwSingular(t.attr("data-id"),t);var o=decodeURIComponent(t.attr("data-outputurl")),a={RenderURL:o,Operation:1,ZOrder:3},i={};i.rid=$(".main-rList .rList-show").attr("data-peerId"),i.params=JSON.stringify(a),oUtils.ajaxReq("/producerpro/notify_htmlurl_tor",i),$("#SingularPlayer").attr("src",o)}),$(".pretreat-content").on("click",".singular-logo .edit",function(){$(".sd-pretreat-show .show-singular").addClass("hide"),$(".sd-operation-show .sd-singular").removeClass("hide")}),$(".overlay-tab").on("click",".colse",function(){$(this).parents(".editSingular").addClass("hide")}),$(".operation-show .operation-view-singular").on("click",".sub_content li .edit",function(){for(var t=$(this).parent(),o=t.attr("data-id"),a=t.attr("data-param"),i=JSON.parse(decodeURIComponent(a)),n=Object.keys(i.controlNode.payload),e="",s=0;s<n.length;s++)e+='<li><span class="txt-title">'+n[s]+'</span><input type="text" value="'+i.controlNode.payload[n[s]]+'"></li>';return $(".overlay-tab .editSingular").attr("data-id",o),$(".overlay-tab .editSingular").attr("data-param",a),$(".overlay-tab .editSingular .singular-complist").html(e),$(".overlay-tab .editSingular").removeClass("hide"),!1}),$(".overlay-tab").on("click",".footer button",function(){for(var t=$(this).parents(".editSingular"),o=t.attr("data-id"),a=JSON.parse(decodeURIComponent(t.attr("data-param"))),i=a.controlNode.payload,n=t.find(".singular-complist li"),e=0;e<n.length;e++)i[n.eq(e).find(".txt-title").html()]=n.eq(e).find("input").val();pvwPlayer.getMainComposition().getCompositionById(o).setPayload(i),changeComp[o]={compositionName:a.compositionName,controlNode:{payload:i}},a.controlNode.payload=i,$(".sd-singular .sub_content [data-id='"+o+"']").attr("data-param",encodeURIComponent(JSON.stringify(a))),t.addClass("hide")}),$(".overlay-tab .operation-btns").on("click",".op-label.operation-singular",function(){$(".overlay-tab .editSingular").addClass("hide"),getSingularCount()}),$(".operation-show .operation-view-singular").on("click",".single-view .sub_content li",function(){var t=$(this),o=t.attr("data-id");if(t.hasClass("pvwActive")){PlayOut(o),t.removeClass("pvwActive");for(var a=0;a<pvwStates.length;a++)if(pvwStates[a].compositionName==t.attr("data-compname")){pvwStates.splice(a,1);break}}else{if(PlayIn(o),0!==t.siblings(".pvwActive").length)for(a=0;a<pvwStates.length;a++)if(pvwStates[a].compositionName==t.siblings(".pvwActive").attr("data-compname")){pvwStates.splice(a,1);break}pvwStates.push({compositionName:t.attr("data-compname"),animation:{action:"play",to:"In"}}),t.addClass("pvwActive").siblings().removeClass("pvwActive")}}),$(".editSingular .singular-complist").fnNiceScroll();