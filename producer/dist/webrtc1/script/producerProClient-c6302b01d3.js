"use strict";var dataArray,_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},peerClientStatusArr={isWebRTCDisconnect:!1,previewList:!1,disconnectNum:0,ipsourceFileName:"",clearDisconnectPrompt:!1,previewListNum:0,videoResetNumObj:{},videoResetNumObjTime:void 0,backData:{},googTargetDelayMs:{},userNotExists:[],resetVideoList:[],dataArray:{}},CONSTANTS={logIn:"login",logOut:"logout",callRequest:"call_request",callResponse:"call_response",disconnectPeer:"disconnectpeer",peerAnswer:"answer",peerOffer:"offer",peerIce:"ice",userAdd:"useradd",userDel:"userdel",addCall:"addcall",deleteCall:"deletecall",callStatus:"status",updateAddSessions:"AddSessions",updateDelSessions:"DelSessions",RTT:"RTT"},STATUS={SUCCESS:1,FAILED:2,REQUST:3,RESPONSE:4,DIALING:5,ENDED:6,RETRY:7},offerOptions={offerToReceiveAudio:1,offerToReceiveVideo:0,voiceActivityDetection:!1},iceUrl={iceServers:[{urls:"turn:rtcturn.tvunetworks.com:13478",username:"tvu",credential:"tvu"},{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.sipgate.net"}]},videoDom={input:$("#preview"),output:$(".main-output .output-source .big-video")},Signaling=function(e){var i=new io(e);this.sock=i,this.send=function(e,t){i.emit(e,t)},this.on=function(e,t){i.on(e,t)}},replayTimer="",setimeout=200,timeBase={},pts0={};function setChannelEvents(e,t,d,c){e.onmessage=function(e){var t=JSON.parse(e.data);if($(".preview-source .main-player").attr("id")==d&&t.replay_status){var i=base64js.toByteArray(t.replay_status),r=i[4],n=Read24n8(i,5),a=(Read24n8(i,11),Read24n8(i,17)),s={replayPosition:n,replayDuration:a,replayStatus:r=128==r||129==r};setimeout=a-n,clipDot.createStatusOverdue(s),clearTimeout(replayTimer),replayTimer=setTimeout(function(){console.log("执行了init replay");clipDot.createStatusOverdue({replayPosition:0,replayDuration:0,replayStatus:!1})},setimeout)}getStats(c,function(e){var t="";if(e.video.recv.tracks&&e.video.recv.tracks[0]){t=e.video.recv.tracks[0].substring(6);for(var i=0;i<e.results.length;i++){if(-1!==JSON.stringify(e.results[i]).indexOf("googTargetDelayMs")){peerClientStatusArr.backData[t]={},peerClientStatusArr.backData[t].delayMST=e.results[i].googTargetDelayMs||0,peerClientStatusArr.backData[t].delayMSC=e.results[i].googCurrentDelayMs||0,peerClientStatusArr.backData[t].frameRate=e.results[i].googFrameRateReceived||24;break}}}});var o=JSON.parse(e.data);peerClientStatusArr.dataArray[d]||(peerClientStatusArr.dataArray[d]=[]),pts0[d]||(pts0[d]=o.ts,timeBase[d]=Date.now());var l=peerClientStatusArr.dataArray[d];0==l.length?l.push({pts:o.ts,curDelay:peerClientStatusArr.backData[d].delayMSC,rt:Date.now(),fps:peerClientStatusArr.backData[d].frameRate,tarDelay:peerClientStatusArr.backData[d].delayMST}):o.ts-l[0].pts<3e3?l.push({pts:o.ts,curDelay:peerClientStatusArr.backData[d].delayMSC,rt:Date.now(),fps:peerClientStatusArr.backData[d].frameRate,tarDelay:peerClientStatusArr.backData[d].delayMST}):(l.push({pts:o.ts,curDelay:peerClientStatusArr.backData[d].delayMSC,rt:Date.now(),fps:peerClientStatusArr.backData[d].frameRate,tarDelay:peerClientStatusArr.backData[d].delayMST}),l.shift())},e.onopen=function(){e.send(t+":first text message over RTP data ports=====")},e.onclose=function(e){console.error(t,e)},e.onerror=function(e){console.error(t,e)}}function Read24n8(e,t){var i=e[t],r=e[t+1];return e[t+3]|r<<8|i<<16|e[t+4]<<24}var PeerClient=function(e){this.type_=e.type,this.peerName_=e.name,this.peerRtt=0,this.timerIceRestart={},this.offerOptions_=e.offerOptions,this.serverUrl_=e.serverUrl,this.sendSignalingMessage=e.signaling,this.localStream=e.stream,this.audioRecvBitrate=e.audioRecvBitrate,this.canAddICE=!1,this.pc=new RTCPeerConnection(this.serverUrl_),this.pc.onicecandidate=this.onIceCandidate.bind(this),this.pc.onaddstream=this.onRemoteStreamAdded.bind(this),this.pc.onremovestream=console.log.bind(null,"Remote stream removed."),this.localStream&&this.pc.addStream(this.localStream);var t=this;this.pc.ondatachannel=function(e){this.fromPeerChannel=e.channel,setChannelEvents(this.fromPeerChannel,"frompeer",t.peerName_,t.pc),this.fromPeerChannel.send("=== nice to meet you")},this.toPeerChannel=this.pc.createDataChannel("WorldChannel",null),setChannelEvents(this.toPeerChannel,"topeer",this.peerName_,this.pc),this.pc.onsignalingstatechange=this.onSignalingStateChanged.bind(this),this.pc.oniceconnectionstatechange=this.onIceConnectionStateChanged.bind(this),this.type_==CONSTANTS.peerOffer?this.createOffer():this.setRemoteSDP(e.offer)};function updateBandwidthRestriction(e,t){return e=-1===e.indexOf("b=AS:")?e.replace(/c=IN IP4 (.*)\r\n/,"c=IN IP4 $1\r\nb=AS:"+t+"\r\n"):e.replace(/b=AS:(.*)\r\n/,"b=AS:"+t+"\r\n")}function getOpusPayloadType(e){var t=new RegExp("a=rtpmap:(\\d+) opus\\/\\d+"),i=e.match(t);return i&&2===i.length?i[1]:null}function setOpusParam(e,t){var i="/(a=fmtp: "+t+") (.*)\\r\\n/";return e.replace(i,"$1 $2;stereo=1;maxaveragebitrate=256000\r\n")}function sortVideo(e,t){var i=parseInt($(e).attr("data-rid"),16),r=parseInt($(t).attr("data-rid"),16);return i<r?-1:r<i?1:0}function sortRpsVideo(e,t){var i=parseInt($(e).attr("data-filename").slice(-1)),r=parseInt($(t).attr("data-filename").slice(-1));return i<r?-1:r<i?1:0}PeerClient.prototype.updateCallStaus=function(e,t){var i={};i.type=CONSTANTS.callStatus;var r={peername:this.peerName_,status:e,msg:t};i.content=JSON.stringify(r),this.sendSignalingMessage(i)},PeerClient.prototype.onSetRemoteSDP=function(){this.canAddICE=!0,this.pc.createAnswer().then(this.getLocalDescription.bind(this)).catch(this.onSetSessionDescriptionError.bind(this))},PeerClient.prototype.setRemoteSDP=function(e){var i=this;this.pc.setRemoteDescription(new RTCSessionDescription(e)).then(function(t){t.getTracks().forEach(function(e){return i.pc.addTrack(e,t)}),i.onSetRemoteSDP.bind(i)}).catch(this.onSetSessionDescriptionError.bind(this))},PeerClient.prototype.createOffer=function(e){e&&(this.offerOptions_.iceRestart=!0),this.pc.createOffer(this.offerOptions_).then(this.getLocalDescription.bind(this)).catch(this.onSetSessionDescriptionError.bind(this))},PeerClient.prototype.onSetLocalSDPSuccess=function(e){var t={};t.to=this.peerName_,t.sdp=e.sdp,t.type=e.type;var i={};"answer"==t.type?i.type=CONSTANTS.peerAnswer:i.type=CONSTANTS.peerOffer,i.content=JSON.stringify(t),this.sendSignalingMessage(i),this.updateCallStaus(STATUS.DIALING)},PeerClient.prototype.getLocalDescription=function(e){var t=getOpusPayloadType(e.sdp);null!=t&&(e.sdp=setOpusParam(e.sdp,t)),this.pc.setLocalDescription(e).then(this.onSetLocalSDPSuccess.bind(this,e)).catch(this.onSetSessionDescriptionError.bind(this))},PeerClient.prototype.onSetSessionDescriptionError=function(e){oUtils.alertTips("i18n_webRTCSeverError"),console.error("Failed to set session description: "+e.toString()),this.updateCallStaus(STATUS.RETRY,err)},PeerClient.prototype.onSignalingStateChanged=function(e){},PeerClient.prototype.onIceConnectionStateChanged=function(e){if("connected"==this.pc.iceConnectionState&&this.updateCallStaus(STATUS.SUCCESS),"failed"==this.pc.iceConnectionState&&(errorMsg({name:this.peerName_,message:"Ice connection "+this.pc.iceConnectionState}),this.logIn=!1,void 0!==window.rtcclient&&!isEmptyObject(window.rtcclient.call_))){var t={from:this.peerName_,ack:!1};window.rtcclient.call_.stopPeer(JSON.stringify(t)),this.updateCallStaus(STATUS.RETRY)}},PeerClient.prototype.deleteAudio=function(e){this.updateCallStaus(STATUS.ENDED)},PeerClient.prototype.onaddtrack=function(e){console.log(e)},PeerClient.prototype.onRemoteStreamAdded=function(e){var i=this.peerName_;if(console.log(i+"success"),-1<currentRInfo.rtcIdList.pvw.indexOf(i)||-1<currentRInfo.rtcIdList.pgm.id.indexOf(i)){var t='<video  autoplay playsinline class="left main-player" id="'+i+'"></video>',r=null;(r=-1<currentRInfo.rtcIdList.pvw.indexOf(i)?videoDom.input:videoDom.output).html(t),r.find("video")[0].srcObject=e.stream,r.find("video")[0].play();if(r.parent().append('<div class="left audio">                            <div class="row left">                                <div class="bg">                                    <div class="back container">                                        <div class="active"></div>                                    </div>                                </div>                            </div>                            <div class="row right">                                <div class="bg">                                    <div class="back container">                                        <div class="active"></div>                                    </div>                                </div>                            </div>                        </div>'),-1<currentRInfo.rtcIdList.pvw.indexOf(i))$(".apply-preview .radius-box").hasClass("shut")&&$(".main-preview .audio").css("display","none"),r.find("video")[0].volume=0,r.find("video")[0].muted=!0,currentRInfo.rtcIdList.pvw=[];else{var n=currentRInfo.rtcIdList.pgm.data;$(".main-output").attr("data-filename",n.CurrentEncoderSharedMemory.SharedMemoryName),null!==n.CurrentPIPList&&0<n.CurrentPIPList.length&&$(".main-output").attr("data-pipfilename",n.CurrentPIPList[0].id),$(".main-output .output-erphone .icon-erphone").hasClass("active")?(r.find("video")[0].volume=1,r.find("video")[0].muted=!1):(r.find("video")[0].volume=0,r.find("video")[0].muted=!0),currentRInfo.rtcIdList.pgm.id=[],currentRInfo.rtcIdList.pgm.data=null}}else if(-1<peerClientStatusArr.resetVideoList.indexOf(i)){var a=getVideoStyle(i),s=a.videoObj,o="<video autoplay "+a.style+" id="+i+"></video>",l=s.parent();s.replaceWith(o),(s=l.find("video"))[0].srcObject=e.stream,s[0].volume=0,(peerClientStatusArr.disconnectNum=0)!==$("#preview .pip").length&&$("#preview .pip").find("video").attr("data-videoid")==i&&createPipVideo(i);var d=peerClientStatusArr.resetVideoList.indexOf(i);-1<d&&peerClientStatusArr.resetVideoList.splice(d,1)}else if(-1<currentRInfo.rtcIdList.preLis.idArr.indexOf(i)){var c=null,p="",h="";currentRInfo.rtcIdList.preLis.data.forEach(function(e,t){e.PreviewID==i&&(c=e)});var u="";if(c.PreviewShm.R_ID&&(p=" data-rid="+(p=c.PreviewShm.R_ID),u="isr"),"Default"===c.PreviewShm.SharedMemoryName&&(p="data-rid="+(p=$(".main-rList .rList-show").attr("data-peerid")).toUpperCase(),u="isr"),peerClientStatusArr.videoResetNumObj[i]&&delete peerClientStatusArr.videoResetNumObj[i],100==c.PreviewShm.SourceType)h="icon-ext";else if(200==c.PreviewShm.SourceType)peerClientStatusArr.ipsourceFileName=c.PreviewShm.FileName,h="icon-ip-source";else if(600==c.PreviewShm.SourceType)h="icon-quadView";else if(h="icon-pack",statusObj.isVoIpFunction)var v="icon-msnui-telephone";var g='<li class="preview-item '+u+'" data-filename="'+c.PreviewShm.SharedMemoryName+'" '+p+'>                                    <div  style="position:relative">                                        <video autoplay playsinline class="preview-item-video" id='+i+'></video>                                        <div class="slider-vertical voice-control"></div>                                        <div class="left audio">                                            <div class="row left">                                                <div class="bg">                                                    <div class="back container">                                                        <div class="active"></div>                                                    </div>                                                </div>                                            </div>                                            <div class="row right">                                                <div class="bg">                                                    <div class="back container">                                                        <div class="active"></div>                                                    </div>                                                </div>                                            </div>                                        </div>                                    </div>                                    <div class="preview-item-control clearFix">                                        <div class="item-control-setting left" >                                            <span class="iconfont '+h+' set-name left"></span>                                            <div class="edit-name left"><input type="text" style="display:none"><div class="show-name"></div></div>                                        </div>                                        <div class="item-control-voice erphone right">                                            <span class="iconfont voip-calling '+v+'"></span>                                            <span class="iconfont icon-erphone"></span>                                            <span class="iconfont voice icon-novoice"></span>                                        </div>                                    </div>                                    <span class="preview-item-num"></span>                                    </li>',f=$(".sd-preview-list .preview-content");0==c.PreviewShm.SourceType||300==c.PreviewShm.SourceType?f.prepend(g):f.append(g);var m=320*f.find(".preview-item").length-20+"px";f.css("width",m),$(".preview-list-container").fnNiceScroll("#444"),$("#"+i)[0].srcObject=e.stream,$("#"+i)[0].muted=!0,$("#"+i)[0].play(),$("#"+i)[0].volume=0;var S=f.find(".preview-item"),w=[],C=[],y="",O=[];$.each(S,function(e,t){var i=$(t).attr("data-filename");"Default"==i?y=t:-1<i.indexOf("(R Shim)")?w.push(t):-1<i.indexOf("-C")?O.push(t):-1<i.indexOf("(IP Shim)")?C.unshift(t):C.push(t)}),0!=w.length&&(w=w.sort(sortVideo)),0!=O.length&&(w=O.sort(sortRpsVideo)),(w=w.concat(C)).unshift(y),w.forEach(function(e,t){$(e).find(".preview-item-num").html(t+1),f.append(e)}),videoDom.timer&&clearTimeout(videoDom.timer),videoDom.timer=setTimeout(function(){$.each($(".preview-content").find("video"),function(e,t){t.play()})},2e3),peerClientStatusArr.previewListNum>=$(".preview-content .preview-item").length&&(peerClientStatusArr.previewList=!0),0!==$("#preview .pip").length&&$("#preview .pip").find("video").attr("data-videoid")==i&&(delete peerClientStatusArr.videoResetNumObj[i],createPipVideo(i)),0!==$("#preview .pip").length&&$("#preview .pip").attr("data-pipvideosharedmemoryname")==c.PreviewShm.SharedMemoryName&&createPipVideo(i),volume.volumeColumn.volumeObj[c.PreviewShm.SharedMemoryName]?c.CurrentVolume=volume.volumeColumn.volumeObj[c.PreviewShm.SharedMemoryName].CurrentVolume:c.CurrentVolume=0;var A=volume.volumeConversion.volumeR2local(c.CurrentVolume);0<A&&$('.preview-content [data-filename="'+c.PreviewShm.SharedMemoryName+'"]').find(".voice").removeClass("icon-novoice").addClass("icon-voice"),(100<A||A<0)&&console.log(volume.volumeColumn.volumeObj[c.PreviewShm.SharedMemoryName].CurrentVolume),volume.createVoiceControl(A,$('.preview-content [data-filename="'+c.PreviewShm.SharedMemoryName+'"]'),"vertical");c.PreviewShm.SharedMemoryName;var T=currentRInfo.rtcIdList.preLis.idArr.indexOf(i);-1<T&&currentRInfo.rtcIdList.preLis.idArr.splice(T,1)}else if(statusObj.voIpFlag){(t=document.createElement("div")).setAttribute("id",i),t.setAttribute("class","singleViopDiv");var N=document.createElement("AUDIO");N.setAttribute("autoplay","autoplay"),N.srcObject=e.stream,t.appendChild(N),console.log(t),$(".voip-calling[data-peertid='"+i+"']").append(t);var R=i.slice(2).toLowerCase();$(".voip-calling[data-rlivepeerid='"+R+"']").addClass("Connected"),$(".voip-calling[data-rlivepeerid='"+R+"']").removeClass("loading-voip-color"),$(".voip-calling[data-rlivepeerid='"+R+"']").addClass("icon-msnui-telephone")}},PeerClient.prototype.onIceCandidate=function(e){if(e.candidate){var t={to:this.peerName_,candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex},i={};i.type=CONSTANTS.peerIce,i.content=JSON.stringify(t),this.sendSignalingMessage(i)}};var Call=function(e){this.iceCache_={},this.peerClients_={},this.sendSignalingMessage=null};Call.prototype.dealOffer=function(e){var t={};t.type=CONSTANTS.peerAnswer,t.offerOptions=offerOptions,t.serverUrl=iceUrl,t.offer=JSON.parse(e.offer),t.stream=e.stream,t.peers=[t.offer.from],this.addPeer(t)},Call.prototype.dealAnswer=function(e){var t=JSON.parse(e),i=t.from;if(void 0!==this.peerClients_[i]){clearInterval(this.peerClients_[i].timerIceRestart);var r=this.peerClients_[i];r.pc.setRemoteDescription(new RTCSessionDescription(t)).then(function(){r.canAddICE=!0,window.rtcclient.call_.dealIceCandidateCache(r.peerName_)}).catch(function(e){console.error(i,e.toString())})}else console.error("pc not found")},Call.prototype.dealIceCandidateCache=function(e){function t(){}function i(e){console.error("Failed to add ICE Candidate: "+e.toString())}if(void 0!==this.peerClients_[e]){if(void 0===this.iceCache_[e])return void console.error("no ice cache for "+e);var r=this.peerClients_[e],n=r.pc;if(r.canAddICE)for(;this.iceCache_[e].length;)n.addIceCandidate(new RTCIceCandidate(this.iceCache_[e].shift()),t,i)}else console.error("pc not found: "+e)},Call.prototype.dealIceCandidate=function(e){var t=e.from,i=e.ice;this.iceCache_.hasOwnProperty(t)||(this.iceCache_[t]=[]),this.iceCache_[t].push(i),this.dealIceCandidateCache(t)},Call.prototype.addPeer=function(e){for(var t=e.peers.length;t--;){var i=e.peers[t].trim(),r=e;r.name=i,r.signaling=this.sendSignalingMessage,this.iceCache_.hasOwnProperty(i)&&(r.ice=this.iceCache_[i],delete this.iceCache_[i]),this.peerClients_[i]=new PeerClient(r),this.peerClients_[i].stop=this.stopPeer.bind(this)}},Call.prototype.leave=function(){var e=Object.keys(this.peerClients_),t=e.length;for(peerclientId in window.rtcclient.call_.peerClients_)clearInterval(window.rtcclient.call_.peerClients_[peerclientId].timerStats);for(;t--;){var i=e.shift(),r={ack:!0};r.from=i,this.stopPeer(JSON.stringify(r))}},Call.prototype.stopPeer=function(e){var t=JSON.parse(e),i=t.from,r=this.peerClients_[i];if(void 0!==this.peerClients_[i]){var n=r.pc,a={type:CONSTANTS.disconnectPeer,content:JSON.stringify({to:i})};this.sendSignalingMessage(a),t.ack&&(a={type:CONSTANTS.disconnectPeer,content:JSON.stringify({to:i})},this.sendSignalingMessage(a)),n.close(),r.deleteAudio(i),clearInterval(this.peerClients_[i].timerIceRestart),delete this.peerClients_[i]}isEmptyObject(this.peerClients_)&&window.rtcclient.stopStream()};var RtcClient=function(e,t){this.logIn=!1,this.needCallAfterLogIn=!0,this.peerid_=null,this.reqTimer=null,this.passwd=Math.random().toString(36).substr(2),null!=e.caller&&(this.peerid_=e.caller.trim()),(this.callee_=null)!=e.callee&&(this.callee_=e.callee.split(",")),this.mediaConstraints_=e.mediaConstraints,this.recvvideo=e.recvvideo,this.recvaudio=e.recvaudio,this.audioRecvBitrate=e.audioRecvBitrate,this.iceCache_={},this.call_={},this.localStream_={},this.sigChannel_=new Signaling(t),this.initSigChannel(),this.RTT=0,this.rttTimer()};function errorMsg(a){var e="type: "+a.name+", message: "+a.message;if(console.log((new Date).getTime(),new Date),console.log(e),statusObj.voIpFlag){-1<a.message.indexOf("Failed to get access to local media")?(oUtils.alertTips("i18n_VOIPUserMediaFailed",2e3),a.name=a.name[0]):(-1<a.message.indexOf("Busy!")||"Peer refuse call request"==a.message||"peer is busy"==a.message)&&oUtils.alertTips("i18n_callConnectionFail"),statusObj.voIpFlag=!1;var t=a.name.slice(2).toLowerCase(),i=currentRInfo.voIpTlist[t];return $(".preview-item[data-rid='"+i+"']").find(".voip-calling").removeClass("Connected"),$(".preview-item[data-rid='"+i+"']").find(".voip-calling").addClass("icon-msnui-telephone"),$(".preview-item[data-rid='"+i+"']").find(".voip-calling").removeClass("loading-voip-color"),!1}if(-1<e.indexOf("Ice connection failed")){peerClientStatusArr.resetVideoList&&-1<!peerClientStatusArr.resetVideoList.indexOf(a.name)&&peerClientStatusArr.resetVideoList.push(a.name),on_leave(a.name);a.name;var r=getVideoStyle(a.name),n=$(r.videoObj),s=(r.style,n.width()),o=n.height(),l='<div style="line-height:'+o+"px;text-align:center;background-color:#000;width:"+s+"px;height:"+o+'px"   id='+a.name+'><img src="./images/video_loading.gif" /></div>';n.replaceWith(l),2<=peerClientStatusArr.disconnectNum?(oUtils.alertTips("i18n_webRTCOffline"),initSystem.webrtcVideo.initFlag=!0,peerClientStatusArr.clearDisconnectPrompt=!0,resetPage()):(peerClientStatusArr.disconnectNum++,console.log([a.name],"Ice connection failed"),on_rtc([a.name]))}if(-1<e.indexOf("User not exists"))if(0!==(n=$("#"+a.name)).length)peerClientStatusArr.videoResetNumObjTime=setTimeout(function(){peerClientStatusArr.resetVideoList&&-1<!peerClientStatusArr.resetVideoList.indexOf(a.name)&&peerClientStatusArr.resetVideoList.push(a.name),on_leave(a.name);a.name;var e=getVideoStyle(a.name),t=$(e.videoObj),i=(e.style,t.width()),r=t.height(),n='<div style="line-height:'+r+"px;text-align:center;background-color:#000;width:"+i+"px;height:"+r+'px"   id='+a.name+'><img src="./images/video_loading.gif" /></div>';t.replaceWith(n),console.log([a.name],"User not exists"),on_rtc([a.name])},2e3);else{if(peerClientStatusArr.videoResetNumObj[a.name]?peerClientStatusArr.videoResetNumObj[a.name]--:peerClientStatusArr.videoResetNumObj[a.name]=5,peerClientStatusArr.videoResetNumObj[a.name]<=0)return!1;-1<currentRInfo.rtcIdList.pvw.indexOf(a.name)||-1<currentRInfo.rtcIdList.pgm.id.indexOf(a.name)?(clearTimeout(peerClientStatusArr.videoResetNumObjTime),peerClientStatusArr.videoResetNumObjTime=setTimeout(function(){on_leave(a.name),initSystem.webrtcVideo.initFlag=!0,-1<currentRInfo.rtcIdList.pvw.indexOf(name)?currentRInfo.rtcIdList.pvw=[]:currentRInfo.rtcIdList.pgm.id=[]},2e3)):(peerClientStatusArr.userNotExists.push(a.name),clearTimeout(peerClientStatusArr.videoResetNumObjTime),peerClientStatusArr.videoResetNumObjTime=setTimeout(function(){for(var e=peerClientStatusArr.userNotExists,t=0;t<e.length;t++){var i=initSystem.webrtcVideo.peerIds.indexOf(e[t]);-1<i&&(on_leave(e[t]),initSystem.webrtcVideo.peerIds.splice(i,1),currentRInfo.rtcIdList.preLis.idArr.splice(i,1))}peerClientStatusArr.userNotExists=[]},7e3))}if(-1<e.indexOf("already exists")){var d=initSystem.webrtcVideo.peerIds.indexOf(a.name);-1<d&&(on_leave(a.name),initSystem.webrtcVideo.peerIds.splice(d,1))}}function isEmptyObject(e){for(var t in e)return!1;return!0}function calPts(e){var t,i=Date.now(),r=peerClientStatusArr.dataArray[e];if(0!==r.length){for(t=0;t<r.length;t++)if(i-r[t].rt-r[t].tarDelay<1e3/r[t].fps)return r[t].pts;return t===r.length?r[t-1].pts:void 0}}function on_login(e){0!=e.length?(window.rtcclient.peerid_=e,window.rtcclient.sendEvent(CONSTANTS.logIn,JSON.stringify({username:window.rtcclient.peerid_,passwd:window.rtcclient.passwd}))):(err="Username cannnot be empty",errorMsg({name:"user",message:err}))}function on_rtc(e,t){console.log(e),t&&(peerClientStatusArr.previewListNum+=t.length),e.length?(window.rtcclient.needCallAfterLogIn=!0,window.rtcclient.callee_=e,window.rtcclient.onLogIn({success:!0},e)):(err="Callee is empty",errorMsg({name:"user",message:err}))}function on_leave(e){void 0===window.rtcclient||isEmptyObject(window.rtcclient.call_)||(e?window.rtcclient.call_.stopPeer(JSON.stringify({from:e,ack:!0})):window.rtcclient.leave())}function getVideoStyle(e){var t,i=$("#"+e),r={};return t=(r.videoObj=i).parent().hasClass("preview-item")?"height=168 width=300 class='preview-item-video'":i.parent().parent().hasClass("preview-source")||i.parent().parent().hasClass("output-source")?"autoplay class='left main-player'":"style='display:inline-block;z-index:1;width:100%;height:100%;' class='preview-item-video'",r.style=t,r}RtcClient.prototype.rttTimer=function(){setInterval(function(){this.rttStartTime=new Date,this.sendEvent(CONSTANTS.RTT,JSON.stringify({rtt:this.RTT}))}.bind(this),6e4)},RtcClient.prototype.callStaus=function(e,t){for(var i in this.callee_)if(null!=this.callee_[i]){var r={peername:this.callee_[i],status:e,msg:t};this.sendEvent(CONSTANTS.callStatus,JSON.stringify(r))}},RtcClient.prototype.isOnline=function(){return this.logIn},RtcClient.prototype.registerEvent=function(e,t){this.sigChannel_.on(e,t.bind(this))},RtcClient.prototype.sendEvent=function(e,t){this.sigChannel_.send(e,t)},RtcClient.prototype.onSigServerConnected=function(){if(console.log("connect "),this.peerid_&&!this.logIn&&(console.log("begin log in"),this.needCallAfterLogIn=!1,this.sendEvent(CONSTANTS.logIn,JSON.stringify({username:this.peerid_,passwd:this.passwd}))),0!=currentRInfo.rtcIdList.pvw.length||0!=currentRInfo.rtcIdList.pgm.id.length){if(0!=currentRInfo.rtcIdList.pvw.length)return on_rtc(currentRInfo.rtcIdList.pvw),!1;on_rtc(currentRInfo.rtcIdList.pgm.id)}else 0!=currentRInfo.rtcIdList.preLis.idArr.length?on_rtc(currentRInfo.rtcIdList.preLis.idArr):0!=peerClientStatusArr.resetVideoList.length&&on_rtc(peerClientStatusArr.resetVideoList)},RtcClient.prototype.initSigChannel=function(){this.registerEvent("connect",this.onSigServerConnected),this.registerEvent("error",function(e){console.log("error "+e)}),this.registerEvent(CONSTANTS.RTT,function(e){this.RTT=(new Date-this.rttStartTime)/2;var t=JSON.parse(e);for(var i in t)void 0!==this.call_.peerClients_[i]&&(this.call_.peerClients_[i].peerRtt=t[i])}),this.registerEvent("disconnect",function(){console.log("disconnect"),this.logIn=!1}),this.registerEvent(CONSTANTS.logIn,this.onLogIn),this.registerEvent(CONSTANTS.userAdd,this.onUserAdd),this.registerEvent(CONSTANTS.userDel,this.onUserDel),this.registerEvent(CONSTANTS.callRequest,this.onCallRequest),this.registerEvent(CONSTANTS.callResponse,this.onCallResponse),this.registerEvent(CONSTANTS.peerIce,this.onIce),this.registerEvent(CONSTANTS.peerOffer,this.onOffer),this.registerEvent(CONSTANTS.peerAnswer,this.onAnswer),this.registerEvent(CONSTANTS.disconnectPeer,this.onDiscPeer),this.registerEvent(CONSTANTS.addCall,this.onAddCall),this.registerEvent(CONSTANTS.deleteCall,this.onDeleteCall)},RtcClient.prototype.onUserAdd=function(e){e.user,window.rtcclient.peerid_},RtcClient.prototype.onUserDel=function(e){if(void 0!==window.rtcclient&&!isEmptyObject(window.rtcclient.call_))e.user},RtcClient.prototype.onUserMediaSuccess=function(e){this.localStream_=e},RtcClient.prototype.onUserMediaError=function(e,t){var i="Failed to get access to local media. Error name was "+e.name;errorMsg({name:t,message:i}),this.callStaus(STATUS.FAILED,i)},RtcClient.prototype.onGetStream=function(e){this.onUserMediaSuccess(null),this.startCall()},RtcClient.prototype.addSessions=function(e){this.sendEvent(CONSTANTS.updateAddSessions,JSON.stringify(e))},RtcClient.prototype.onLogIn=function(e,t){e.success?(this.logIn=!0,this.createCall(),this.needCallAfterLogIn&&null!=this.callee_&&(this.needCallAfterLogIn=!1,this.addSessions(this.callee_),statusObj.voIpFlag?(this.mediaConstraints_.audio=!0,navigator.mediaDevices.getUserMedia(this.mediaConstraints_).then(function(e){this.onUserMediaSuccess(e),this.startCall()}.bind(this)).catch(function(e){this.onUserMediaError(e,t)}.bind(this))):this.mediaConstraints_.audio||this.mediaConstraints_.video?navigator.mediaDevices.getUserMedia(this.mediaConstraints_).then(this.onGetStream.bind(this)).catch(function(e){this.onUserMediaError(e)}.bind(this)):this.onGetStream(null))):(errorMsg({name:"user",message:e.msg}),console.log("onLogIn"))},RtcClient.prototype.onAddCall=function(e){var t=JSON.parse(e);void 0!==window.rtcclient&&(window.rtcclient.callee_=t.to.split(","),window.rtcclient.needCallAfterLogIn=!0,window.rtcclient.onLogIn({success:!0}))},RtcClient.prototype.onDeleteCall=function(e){console.log("delete call from "+e);for(var t=JSON.parse(e).to.split(","),i=t.length;i--;)if(void 0!==window.rtcclient&&!isEmptyObject(window.rtcclient.call_)){var r={from:t[i],ack:!0};window.rtcclient.call_.stopPeer(JSON.stringify(r))}},RtcClient.prototype.onCallRequest=function(e){var t=JSON.parse(e);navigator.mediaDevices.getUserMedia(this.mediaConstraints_).then(function(e){this.onUserMediaSuccess(e),this.sendEvent(CONSTANTS.callResponse,JSON.stringify({to:t.from,response:!0}))}.bind(this)).catch(function(e){this.onUserMediaError(e),this.sendEvent(CONSTANTS.callResponse,JSON.stringify({to:t.from,response:!1}))}.bind(this))},RtcClient.prototype.onCallResponse=function(e){clearTimeout(this.reqTimer);var t=JSON.parse(e);if(t.response){var i={};i.type=CONSTANTS.peerOffer,i.peers=[t.from],i.offerOptions={},i.offerOptions.offerToReceiveVideo=this.recvvideo,i.offerOptions.offerToReceiveAudio=this.recvaudio,i.audioRecvBitrate=this.audioRecvBitrate,i.serverUrl=iceUrl,i.stream=this.localStream_,this.call_.addPeer(i)}else errorMsg({name:t.from,message:t.msg}),this.callStaus(STATUS.RETRY,t.msg),console.log("onCallResponse")},RtcClient.prototype.onIce=function(e){var t=JSON.parse(e),i={};i.candidate=t.candidate,i.sdpMid=t.sdpMid,i.sdpMLineIndex=t.sdpMLineIndex,this.call_.dealIceCandidate({from:t.from,ice:i})},RtcClient.prototype.onDiscPeer=function(e){},RtcClient.prototype.onAnswer=function(e){this.call_.dealAnswer(e)},RtcClient.prototype.onOffer=function(e){var t={stream:this.localStream_,offer:e};this.call_.dealOffer(t)},RtcClient.prototype.createCall=function(){isEmptyObject(this.call_)&&(this.call_=new Call,this.call_.sendSignalingMessage=function(e){this.sendEvent(e.type,e.content)}.bind(this))},RtcClient.prototype.startCall=function(){if(0!=this.callee_.length){var e={ids:this.callee_};this.sendEvent(CONSTANTS.callRequest,JSON.stringify(e)),this.callStaus(STATUS.REQUST),this.reqTimer=setTimeout(function(){this.callStaus(STATUS.RETRY,"requset time out!")}.bind(this),6e4)}else errorMsg({name:"user",message:"callee is empty"})},RtcClient.prototype.addPeer=function(e){this.call_.addPeer(e)},RtcClient.prototype.stopStream=function(){isEmptyObject(this.localStream_)||(this.localStream_.getTracks().forEach(function(e){e.stop()}),delete this.localStream_,this.localStream_=null)},RtcClient.prototype.leave=function(e){isEmptyObject(this.call_)||this.call_.leave(),this.stopStream(),window.rtcclient.sendEvent(CONSTANTS.logOut,JSON.stringify({username:window.rtcclient.peerid_,passwd:window.rtcclient.passwd}))},window.onbeforeunload=function(){window.rtcclient.leave(),window.rtcclient.sendEvent(CONSTANTS.logOut,JSON.stringify({username:window.rtcclient.peerid_,passwd:window.rtcclient.passwd})),delete window.rtcclient};var widthAndHeight={resolutionW:1920,resolutionH:1080,getWTransRate:function(e,t){return e?e.width()/this.resolutionW:t?t/this.resolutionW:void 0},getHTransRate:function(e,t){return e?e.height()/this.resolutionH:t?t/this.resolutionH:void 0},getPriviewWidth:function(e,t,i){if(0==i)return 0;var r=void 0;return e&&(r=this.getWTransRate($(e),null)),t&&(r=this.getWTransRate(null,t)),i?Math.round(i*r):void 0},getPriviewHeight:function(e,t,i){if(0==i)return 0;var r=void 0;return e&&(r=this.getHTransRate($(e),null)),t&&(r=this.getHTransRate(null,t)),i?i*r:void 0},getOutputWidth:function(e,t){if(0==t)return 0;var i=this.getWTransRate($(e));return t?Math.round(t/i):void 0},getOutputHeight:function(e,t){if(0==t)return 0;var i=this.getHTransRate($(e));return t?Math.round(t/i):void 0}},overToPreview={textResize:!0,logoInit:function(e,t){t=t||"#preview";var i=JSON.stringify(e);i=encodeURIComponent(i);var r,n,a=void 0;if(null==e.imageWidth||""==e.imageWidth){var s=e.size.split("x");e.imageWidth=s[0],e.imageHeight=s[1],a=e.imageHeight/e.imageWidth,e.imageWidth=needEven(e.imageWidth),e.imageHeight=Math.round(e.imageWidth*a),a=e.imageHeight/e.imageWidth}widthAndHeight.resolutionW-e.imageWidth<=0&&(e.logoXOffset=widthAndHeight.resolutionW-e.imageWidth),widthAndHeight.resolutionH-e.imageHeight<=0&&(e.logoYOffset=widthAndHeight.resolutionH-e.imageHeight),a||(a=e.imageHeight/e.imageWidth),n=(r=widthAndHeight.getPriviewWidth(t,null,e.imageWidth))*a;var o="",l="",d=widthAndHeight.getPriviewHeight(t,null,e.logoYOffset);e.logoXOffset+e.imageWidth>widthAndHeight.resolutionW/2?(l=widthAndHeight.resolutionW-e.logoXOffset-e.imageWidth,o+="left:",(l=widthAndHeight.getPriviewWidth(t,null,l))<0&&(l=0)):(l=e.logoXOffset,l=widthAndHeight.getPriviewWidth(t,null,l),o+="right:"),r+l>$(t).width()&&(l=$(t).width()-r),n+d>$(t).height()&&(d=$(t).height()-n),o+=l+"px;";var c='<div class="logo-box logoRander logo'+e.id+'" data-params="'+i+'" data-url="'+e.url+'" data-id="'+e.id+'" style="width:'+r+"px;height:"+n+"px;top:"+d+"px; "+o+"z-index:"+e.zorder+';"><img src="'+e.url+'" ondragstart="return false;" alt="" style="display:block;width:100%;height:100%"></div>';0!=$(t+" .logo"+e.id).length?$(t+" .logo"+e.id).replaceWith(c):$(t).append(c),"#preview"==t&&($(".preview-source .logo"+e.id).hasClass(".scoreDiv")||$(".preview-source .logo"+e.id).DragAndDrop({callback:correctDrag.correctLogo,rate:a}))},scoreInit:function(e,t){var i,r,n,a,s;if(t=t||"#preview",e.size){var o=e.size.split("x");e.imageWidth=o[0],e.imageHeight=o[1]}i=widthAndHeight.getPriviewWidth(t,null,e.imageWidth),r=widthAndHeight.getPriviewHeight(t,null,e.imageHeight),n=widthAndHeight.getPriviewHeight(t,null,e.logoYOffset),a=widthAndHeight.getPriviewWidth(t,null,e.logoXOffset);for(var l=$(t).width()-a-i,d=i/e.imageWidth,c='<div class="scoreDiv score-active logo-box score'+e.id+'" data-scoreBord=1 data-imageWidth="'+e.imageWidth+'" data-url="'+e.url+'" data-imageHeight="'+e.imageHeight+'"data-logoYOffset="'+e.logoYOffset+'"  data-logoXOffset="'+e.logoXOffset+'"data-id="'+e.id+'"><div class="score-scale" style="transform-origin:0px 0px 0px;transform:scale('+d+");width:"+e.imageWidth+"px;height:"+e.imageHeight+'px"><img src="'+e.url+'">',p=e.subtitles,h=0;h<p.length;h++){var u=p[h].style;"object"!=(void 0===u?"undefined":_typeof(u))&&(0==u.indexOf('"')&&(u=u.substring(1,u.length-1)),u=JSON.parse(u));var v=u.fontSize;v=widthAndHeight.getPriviewHeight(t,null,v);var g=p[h].yOffset-e.logoYOffset;g=widthAndHeight.getPriviewHeight(t,null,g);var f=p[h].xOffset-e.logoXOffset,m=(f=widthAndHeight.getPriviewWidth(t,null,f),p[h].width);m=widthAndHeight.getPriviewWidth(t,null,m);var S=p[h].height;S=widthAndHeight.getPriviewHeight(t,null,S),"#preview"!=t&&(s="disabled"),c+='<input type="text" class="scoreText scoreText'+(h+1)+'" '+s+' data-zorder=3 value="'+p[h].text+'" data-scoreTextId="'+p[h].id+'"  style=" background-color:transparent;color:#'+u.foregroundColor.slice(2,8)+';">'}c+="</div></div>","#preview"==t?($(t).append(c),$(t+" .score"+e.id).DragAndDrop({resize:!1})):0!=$(t+" .scoreDiv").length?$(t+" .scoreDiv").replaceWith(c):$(t).append(c),$(t+" .scoreDiv").attr("style","position:absolute;top:"+n+"px;left:"+l+"px;z-index:"+e.zorder+";transform:scale(1);width:"+i+"px;height:"+r+"px;"),"zh-CN"==window.navigator.language||"zh"==window.navigator.language?$(".scoreText").css("font-family","SimHei"):("en-US"==window.navigator.language||window.navigator.language,$(".scoreText").css("font-family","Arial"));var w=$(".scoreDiv").attr("data-url"),C=parseInt(w.substring(15,16))+1;$(t+" .scoreDiv").addClass("scorePreview"+C)},textInit:function(e,t){t=t||"#preview";var i,r=encodeURIComponent(JSON.stringify(e));if("#preview"!==t&&(e.style=e.pgmStyle),null==e.logoId||""==e.logoId){"object"!=(void 0===(i=e.style)?"undefined":_typeof(i))&&(0==i.indexOf('"')&&(i=i.substring(1,i.length-1)),i=JSON.parse(i));i.backgroundColor;var n=i.backgroundColor.slice(2,8),a=i.backgroundColor.slice(0,2),s=HexToRgba(n,a),o=i.foregroundColor.slice(2,8),l=widthAndHeight.getPriviewHeight(t,null,e.yOffset),d=widthAndHeight.getPriviewWidth(t,null,e.xOffset),c=widthAndHeight.getPriviewWidth(t,null,i.fontSize);$("#fontFamily").val(i.fontName);var p="contentEditable";"#preview"!=t&&(p="");var h='<div class="textDiv" data-params="'+r+'" onpaste="javascript:return false;"><div class="preTextarea" maxlength="128" '+p+' data-textYOffset="'+l+'"   data-textXOffset="'+d+'" data-Id="'+e.id+'" data-zorder="'+e.zorder+'"   style="white-space:pre;text-overflow: ellipsis; font-size:'+c+"px;right:"+d+"; color:#"+o+"; font-family:"+i.fontName+';" >'+("#preview"!==t?e.pgmText:e.text)+"</div></div>";"#preview"==t?($(t).append(h),$(t+" .textDiv").DragAndDrop({scale:!0,scaleClassName:".preTextarea",callback:correctDrag.textBlur})):0!=$(t+" .textDiv").length?$(t+" .textDiv").replaceWith(h):$(t).append(h);var u=$(t).width()-d-$(t+" .textDiv").width();$(t+" .textDiv").attr("style","position:absolute;top:"+l+"px;left:"+u+"px;z-index:"+e.zorder+";background-color:"+s+";")}},clockInit:function(e,t){var i=encodeURIComponent(JSON.stringify(e));t=t||"#preview";var r,n=e.style;null!=n&&"object"!=(void 0===n?"undefined":_typeof(n))&&(0==n.indexOf('"')&&(n=n.substring(1,n.length-1)),n=JSON.parse(n));n.foregroundColor.slice(2,8);var a=widthAndHeight.getPriviewHeight(t,null,e.yOffset),s=widthAndHeight.getPriviewWidth(t,null,e.xOffset),o=widthAndHeight.getPriviewWidth(t,null,e.width),l=widthAndHeight.getPriviewWidth(t,null,e.height),d=o/e.width,c=n.text,p=c.split(":"),h=60*parseInt(p[0]),u=parseInt(p[1]),v=parseInt(h+u),g=calPts($(".main-preview .main-player").attr("id")),f=e.timestamp,m=e.endTime,S="";e.operation;if("start"!=checkLocation("status"))S=c,r=v;else{var w=g-f;clockObj.clockSeconds=parseInt(w/1e3)+v,r=clockObj.clockSeconds,S=TimeByms(clockObj.clockSeconds)}var C="";C=m/1e3<r?"red":"";var y='<div class="clockDiv" data-params="'+i+'" data-check="'+e.checked+'" data-operation="'+e.operation+'" data-Id="'+e.id+'" data-zorder="'+e.zorder+'" style="'+C+'"><div class="clockTextarea" style="transform-origin:0px 0px 0px;transform:scale('+d+");width:"+e.width+"px;height:"+e.height+"px;line-height:"+e.height+'px;">'+S+"</div></div>";"#preview"==t?(0!=$(t+" .clockDiv").length?$(t+" .clockDiv").replaceWith(y):$(t).append(y),$(t+" .clockDiv").DragAndDrop({resize:!1,callback:correctDrag.correctClock})):0!=$(t+" .clockDiv").length?$(t+" .clockDiv").replaceWith(y):$(t).append(y);var O=$(t).width()-s-$(".clockDiv").width();$(t+" .clockDiv").attr("style","position:absolute;top:"+a+"px;left:"+O+"px;z-index:"+e.zorder+";transform:scale(1);background-color:"+C+";font-size:46px;width:"+o+"px;height:"+l+"px;")},pipInit:function(e,t,i){i=i||"#preview";var r='<div class="pip" style="width:'+widthAndHeight.getPriviewWidth(i,null,e.pipWidth)+"px;height:"+widthAndHeight.getPriviewHeight(i,null,e.pipHeight)+"px;right:"+widthAndHeight.getPriviewWidth(i,null,e.pipXOffset)+"px;top:"+widthAndHeight.getPriviewHeight(i,null,e.pipYOffset)+"px;z-index:"+e.zorder+';" data-pipVideoSharedMemoryName="'+e.pipVideoSharedMemoryName+'" data-pipAudioSharedMemoryName="'+e.pipAudioSharedMemoryName+'" data-pgmPipVideoSharedMemoryName="'+e.pgmPipVideoSharedMemoryName+'"  data-filename="'+e.pipVideoSharedMemoryName+'" data-audiostatus="'+e.audioStatus+'" data-id="'+e.id+'" data-pipWidth="'+e.pipWidth+'"  data-pipHeight="'+e.pipHeight+'"  data-pipXOffset="'+e.pipXOffset+'"  data-pipYOffset="'+e.pipYOffset+'"><video autoplay style="display:inline-block;z-index:1;width:100%;height:100%;" class="preview-item-video"></video></div>';"#preview"==i?($(i).append(r),$("#preview .pip").DragAndDrop({callback:correctDrag.correctPip})):0!=$(i+" .pip").length?$(i+" .pip").replaceWith(r):$(i).append(r),createPipVideo(t,i)},getPipInfo:function(){var e=$("#preview .pip"),t=e.width(),i=e.height(),r=e.position().top;e.position().left;return i=(e=$(".pretreat-content-item[data-id='"+e.attr("data-id")+"']")).attr("data-pipheight"),t=e.attr("data-pipwidth"),r=e.attr("data-pipyoffset"),{pipXOffset:e.attr("data-pipxoffset"),pipYOffset:r,zorder:$("#preview .pip").css("zIndex"),pipWidth:t,pipHeight:i,pipVideoSharedMemoryName:$("#preview .pip").attr("data-pipVideoSharedMemoryName"),pipAudioSharedMemoryName:$("#preview .pip").attr("data-pipAudioSharedMemoryName"),audioStatus:$("#preview .pip").attr("data-audiostatus")}}};