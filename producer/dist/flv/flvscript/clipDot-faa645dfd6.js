"use strict";var clipDot=function(l,t){var s=!1;function o(e,t){var i=parseInt(t/l(".clip-source .source-pic").width()*6e4);return parseInt(e.parents(".source").attr("data-startTimeCode"))+i}function c(e){var t=e.attr("data-starttime"),i=e.attr("data-endtime")-t;e.find(".time-code").html((i/1e3).toFixed(2))}function e(){for(var e=function(){for(var e,t,i=l(".preview-content .preview-item"),a=[],r=0;r<i.length;r++)i.eq(r).attr("data-rid")&&a.push((e=i.eq(r).find("video")[0],t=void 0,(t=document.createElement("canvas")).width=300,t.height=168,t.getContext("2d").drawImage(e,0,0,300,168),t.toDataURL("image/jpeg",1)));return a}(),t="",i=0;i<e.length;i++)t+='<li class="seat video-1">                            <span class="preview-item-num">'+(i+1)+'</span>                            <img src="'+e[i]+'" alt="">                            <div class="remark hide">                                <div class="btn">Rewind last 60s</div>                            </div>                        </li>';l(".pretreat-content.show-clipvideo").removeClass("hide"),l(".show-clipvideo .select-single").html(t)}function d(e,t){var i='<div class="clip" style="position:absolute;z-index:0;height:100%;left:0;top:0;width:100%;"><img class="remark-pic" src="'+("http://"+l(".main-rList .rList-show").attr("data-rip")+":"+l(".main-preview").attr("data-baseurlforthumbnail")+e+".jpg")+'" alt="" style="width:100%;height:100%;"/><img class="apply-btn hide" src="./images/replay.png"/>';i+='<div class="video-process hide">                                <div class="process-inner">                                    <div class="video-len"></div>                                    <div class="current-len">                                        <div class="video-point">                                        </div>                                    </div>                                    <div class="timeCode">                                        <span class="current-time left">10.2</span>                                        <span class="total-time right">60:00</span>                                    </div>                                </div>                            </div>                        </div>',0!=l(".preview-source .clip").length?l(".preview-source .clip").replaceWith(i):l(".preview-source").append(i),function(e){for(var t=l(".source-pic .clip-slider"),i=0,a=0;a<t.length;a++){var r=t.eq(a).attr("data-starttime"),s=t.eq(a).attr("data-endtime");i+=s-r}var n=e/i*100;l(".process-inner .current-len").css("width",n+"%"),l(".process-inner .timeCode .total-time").html((i/1e3).toFixed(2)),l(".process-inner .timeCode .current-time").html((e/1e3).toFixed(2))}(t)}function p(e,t,i){t+=e.BaseUrlForThumbnail,l(".main-preview").attr("data-baseurlforthumbnail",e.BaseUrlForThumbnail);for(var a=t+(i-3e4)+".jpg",r=e.Records[e.Records.length-1],s='<li class="source active clearFix" data-fontCover="'+a+'" data-title="'+r.Title+'" data-tags = "'+JSON.stringify(r.Tags)+'" data-author = "'+l("#user_info_name").attr("title")+'" data-sourceid="'+r.SourceID+'" data-id="'+r.ID+'" data-startTimeCode="'+(i-6e4)+'">                    <div class="source-pic clearFix">                        <div class="pic clearFix">',n=i,o=15e3<=i-r.StartTimestamp?15:(i-r.StartTimestamp)/1e3,c="",d=0;d<o;d++)c='<img src="'+(t+(n-=4e3))+'.jpg" alt="">'+c;return s+=c,s+='</div>                    <div class="clip-slider" data-starttime="'+(i-3e4)+'" data-endtime="'+(i-1e4)+'">                        <div class="left handle leftHandle">                            <span class="iconfont icon-handle"></span>                        </div>                        <div class="right handle rightHandle">                            <span class="iconfont icon-handle"></span>                        </div>                        <div class="time-code">20.00</div>                    </div>                    <div class="mark">                    </div>                </div>            </li>'}function i(t){var e=l(".preview-content .preview-item[data-filename='Default']").attr("data-rid").toLowerCase(),i=l(".clip-source .source.active"),a={rid:e};if("record/express_apply_pvw"==t)var r=l("#preview .main-player").attr("id");var s={Title:i.attr("data-title"),Tags:JSON.parse(i.attr("data-tags")),Author:i.attr("data-author"),Scenes:[{SourceID:i.attr("data-sourceid"),SessionID:i.attr("data-id"),StartTimestamp:i.find(".clip-slider").attr("data-starttime"),EndTimestamp:i.find(".clip-slider").attr("data-endtime"),SpeedRate:l(".clip-dot .sel-speed").attr("data-value"),EffectImageId:l(".clip-dot .pic-submit").attr("data-userlogoid")}],FrontCover:i.attr("data-fontcover")};a.params=JSON.stringify(s),oUtils.ajaxReq(t,a,function(e){"record/express_apply_pvw"==t?(l("#preview").attr("data-storyid",e.Scenes[0].StoryID),webflv.playObj[r].wsreader.onReplay=n):l("#preview").removeAttr("data-storyid")})}function u(e){e?(l(".main-center .main-cut").removeClass("replay"),l(".main-center .main-cut .main-cut-btn").html(t.i18n_VideoCut),l(".preview-source .clip").remove(),l(".main-preview .applyBtn").hasClass("shut")&&(l(".main-center .main-cut").addClass("direct-pgm"),l(".preview-source .maskLayer").removeClass("hide"))):(l(".main-center .main-cut").addClass("replay").removeClass("direct-pgm"),l(".main-center .main-cut .main-cut-btn").html("Replay Cut"),l(".main-preview .applyBtn").hasClass("shut")&&l(".preview-source .maskLayer").addClass("hide"))}function n(e){var t=l("#preview .main-player").attr("id"),i=webflv.playObj[t].player,a=Math.round(1e3*i.currentTime)+i.dtsBase;if(e.replayStatus){var r=e.firstPts-a;0==s&&r<=-1e3/e.refFps&&(s=!0,l(".preview-source .clip img").addClass("hide")),l(".preview-source .clip .video-process").removeClass("hide"),l(".process-inner .current-len").css("width",e.replayPosition/e.replayDuration*100+"%"),l(".process-inner .timeCode .total-time").html((e.replayDuration/1e3).toFixed(2)),l(".process-inner .timeCode .current-time").html((e.replayPosition/1e3).toFixed(2))}else s=!1,l(".preview-source .clip .video-process").removeClass("hide"),l(".preview-source .clip img").removeClass("hide"),l(".process-inner .timeCode .current-time").html("0.00"),l(".process-inner .current-len").css("width","0")}return l(".overlay-tab .operation-clip").on("click",function(){e()}),l(".show-clipvideo .select-single").on("click","li .remark .btn",function(){var o,e,c,t=l(this).parents("li").index(),i=l(".preview-content .preview-item[data-filename='Default']").attr("data-rid").toLowerCase(),a=[],r=l(".preview-content .preview-item").eq(t);a.push(r.attr("data-filename")),o=a,e={rid:i},c=1e3*parseInt((new Date).getTime()/1e3)-5e3,oUtils.ajaxReq("record/current_session",e,function(e){var t=e.Sources,i=l(".main-rList .rList-show"),a=i.attr("data-rip"),r=(i.attr("data-port"),"http://"+a+":"),s="";if(0<t.length)for(var n=0;n<t.length;n++)if(-1<o.indexOf(t[n].ID)){if(null==t[n].Records||0==t[n].Records.length)return oUtils.alertTips("i18n_noSourceNoReplay"),!1;if(!(1e4<c-t[n].Records[t[n].Records.length-1].StartTimestamp&&0==t[n].Records[t[n].Records.length-1].EndTimestamp))return oUtils.alertTips("i18n_noSourceNoReplay"),!1;s+=p(t[n],r,c)}u(!1),l(".clip-dot .clip-source").html(s),d(c-3e4,0),l(".clip-dot").show()})}),l(".clip-dot .close").on("click",function(){l(".clip-dot").hide(),l(".preview-source .clip").remove(),u(!0)}),l(".clip-dot").off("mousedown").on("mousedown",".clip-slider .rightHandle",function(e){var i=(e=e||event).clientX-this.offsetLeft,a=l(this).parent();return 1==s||(l(document).off("mousemove").on("mousemove",function(e){var t=l(".preview-source .clip");return 0!==t.length&&"none"==t.css("display")||function(e,t,i){e=e||event;var a=i.width();i.css("width",e.clientX-t+"px"),i.width()+i.position().left>l(".source-pic .pic").width()?i.css("width",l(".source-pic .pic").width()-i.position().left+"px"):i.width()<1/60*i.parents(".source-pic").width()&&i.css("width",a+"px");var r=o(i,i.width()+i.position().left);i.attr("data-endtime",r),d(1e3*Math.round(r/1e3),r-i.attr("data-starttime")),c(i),u(!1)}(e,i,a),!1}),l(document).off("mouseup").on("mouseup",function(e){return l(document).unbind("mousemove"),l(document).unbind("mouseup"),!1})),!1}),l(".clip-source").on("click",".source .checkbox",function(){var e=l(this);e.hasClass("icon-check")?(e.parent().find(".mark").show(),e.removeClass("icon-check").addClass("icon-uncheck"),e.parent().addClass("active")):(e.parent().find(".mark").hide(),e.removeClass("icon-uncheck").addClass("icon-check"),e.parent().removeClass("active"));var t=l(".clip-source .source.active");if(l(".preview-source .clip").remove(),0<t.length){var i=t.eq(0).find(".clip-slider").attr("data-starttime");d(i=1e3*parseInt(i/1e3))}}),l(".clip-source").off("mousedown").on("mousedown",".clip-slider .leftHandle",function(e){e=e||event;var i=l(this).parent(),a=e.clientX-i[0].offsetLeft;return 1==s||(l(document).off("mousemove").on("mousemove",function(e){var t=l(".preview-source .clip");return 0!==t.length&&"none"==t.css("display")||function(e,t,i){e=e||event;var a=i[0].offsetLeft,r=e.clientX,s=i.width()+a;if(!(r-t<0||s-(r-t)<=1/60*i.parents(".source-pic").width())){i.css("left",r-t+"px"),i.css("width",s-(r-t)+"px");var n=o(i,i.position().left);i.attr("data-starttime",n),i.attr("data-endtime"),d(1e3*Math.round(n/1e3),n-n),c(i),u(!1)}}(e,a,i),!1}),l(document).off("mouseup").on("mouseup",function(e){return l(document).unbind("mousemove"),l(document).unbind("mouseup"),!1})),!1}),l(".preview-source").on("click",".apply-btn",function(){i("record/express_apply_pvw")}),l(".preview-source").on("mouseenter",function(){var e=l(".preview-source .clip");0!==e.length&&0==s&&(e.find(".apply-btn").removeClass("hide"),e.find(".video-process").removeClass("hide"))}),l(".preview-source").on("mouseleave",function(){var e=l(".preview-source .clip");0!==e.length&&0==s&&(e.find(".apply-btn").addClass("hide"),e.find(".video-process").addClass("hide"))}),l(".select-single").on("mouseenter",".seat",function(){l(this).find(".remark").removeClass("hide")}),l(".select-single").on("mouseleave",".seat",function(){l(this).find(".remark").addClass("hide")}),l(".clip-dot").on("change",".operation-uploadLogo",function(){var i=l("#file_trans").val(),e=document.getElementById("file_trans"),a=new Image;a.onload=function(){if(!i.match(/.png$/i))return oUtils.alertTips("i18n_LogoPngFormat"),void l("#file_trans").val("");var e=a.width+"x"+a.height,t=new FormData;t.append("peerId",l(".rList-show").attr("data-peerid")),t.append("size",e),t.append("type",1),t.append("module",1),t.append("upload",l("#file_trans")[0].files[0]),l(".clip-dot .pic-submit").hide(),l(".clip-dot .pic-load").show(),l.ajax({type:"POST",url:"logo_uploadLogo",data:t,processData:!1,contentType:!1,success:function(e){e=JSON.parse(e),l("#file_trans").val(""),"0x0"==e.errorCode&&(l(".clip-dot .pic-submit").css("background-image","url("+e.result.url+")"),l(".clip-dot .pic-submit").attr("data-userlogoid",e.result.userLogoId)),l(".clip-dot .pic-submit").show(),l(".clip-dot .pic-load").hide()},error:function(e){oUtils.alertTips("i18n_uploadLogoFail"),l(".clip-dot .pic-submit").show(),l(".clip-dot .pic-load").hide()}})},a.src=window.URL.createObjectURL(e.files[0])}),l(".clip-dot .sel-speed").createSimulateSelect([{name:"1.0 x",type:"1"},{name:"0.5 x",type:"0.5"}],"","type","name"),{expressApply:i,changeVideoCut:u}}($,switchLangObj);